import{r as m,R as ie,c as E,o as le,g as oe,m as de,a as ue,w as ce,b as p,e as a,j as L,v as $,q as ve,I as b,L as _,N as me,t as S,F as H,f as O,u as pe,s as V,i as f}from"./vendor.Bh3_gxHF.js";import{u as fe,A as ge,C as he}from"./ClientModal.pJeDofWU.js";import{u as ke}from"./useDateValidation.DB0Yy1Bo.js";import{_ as we,c as ye,g as De,h as Te,a as be,d as Ce}from"./index.Cv61STol.js";const _e={class:"task-create-container"},Se={key:0,class:"task-create__loading"},xe={key:1,class:"task-create-content"},Ie={class:"form-group"},qe={class:"date-time-container"},je={class:"form-group"},Ae={class:"custom-select"},Be={class:"form-group"},Me={class:"custom-select"},$e={class:"date-time-container"},Ve={class:"form-group"},Ne={class:"custom-select"},Fe={class:"form-group"},Pe={class:"custom-select"},Ue={class:"form-group"},Ee={class:"custom-select"},Le={class:"form-group"},He={class:"select-placeholder"},Oe={key:0,class:"selected-items-list"},Re={class:"selected-item-info"},Je=["src"],ze={class:"selected-item-name"},Ge=["onClick"],Ye={class:"form-group"},We={class:"select-placeholder"},Ke={key:0,class:"selected-items-list"},Qe={class:"selected-item-info"},Xe=["src"],Ze={class:"selected-item-name"},et=["onClick"],tt={class:"form-actions"},at={type:"submit",class:"btn btn-primary"},st={key:2,class:"dialog-overlay"},nt={__name:"TaskCreate",setup(rt){const u=de(),o=oe(),{checkAccess:R}=fe(),N=ye(),h=De(),x=Te(),J=be(),z=Ce(),{ensureFutureDate:w,isValidFutureDateTime:G,isValidDateTimeRange:Y}=ke(),y=m(!0),c=m("Meet at the villa entrance ## Review property features ## Discuss client preferences"),I=new Date;I.setDate(I.getDate()+1);const F=I.toISOString().split("T")[0],q=m(!1),j=m(!1),D=m(!1),C=m(!1),A=m(null),k=m(!1),d=m(null),e=ie({name:"Visit offshore island",startDate:F,startTime:"10:00",endDate:F,endTime:"12:00",priority:"high",agents:[1,2],agentDetails:[],clients:[3],clientDetails:[],status:"in_progress",attachments:[{id:"file1",name:"villa_floorplan.pdf",type:"PDF",size:1024e3,lastModified:Date.now()},{id:"file2",name:"villa_photo.jpg",type:"JPG",size:524288,lastModified:Date.now()}],description:[]}),B=E(()=>J.agents.map(s=>({id:s.id,name:s.name,avatar:s.avatar||"https://res.cloudinary.com/dnuhjsckk/image/upload/v1739408381/Screenshot_2025-02-13_015617_mhjgby.png",email:s.email}))),W=E(()=>x.clients.map(s=>({id:s.id,name:s.name,avatar:s.profilePicture||"https://example.com/avatars/default.jpg",email:s.email}))),l=m([]),i=m([]);e.agents=l.value.map(s=>s.id),e.agentDetails=l.value,le(()=>{if(B.value.length>0){const s=B.value.slice(0,2);l.value=s,e.agents=l.value.map(t=>t.id),e.agentDetails=l.value}if(o.query.clientId){const s=parseInt(o.query.clientId),t=x.getClientById(s);t&&(i.value=[{id:t.id,name:t.name,avatar:t.profilePicture||"https://example.com/avatars/default.jpg",email:t.email}],e.clients=i.value.map(n=>n.id),e.clientDetails=i.value)}else if(x.clients.length>0){const s=x.clients[0];i.value=[{id:s.id,name:s.name,avatar:s.profilePicture||"https://example.com/avatars/default.jpg",email:s.email}],e.clients=i.value.map(t=>t.id),e.clientDetails=i.value}N.setLayout({hideSidebar:!0,hideHeader:!0,hideFooter:!0,background:"#f9fafb"}),A.value=u.beforeEach((s,t,n)=>{if(D.value){D.value=!1,n();return}if(P()&&U()&&k.value){C.value=!0,n(!1);return}n()}),y.value=!0,R(["agent","admin"]).then(s=>{if(!s){u.push("/unauthorized");return}const t=o.query.draftId;t?re(parseInt(t)).then(()=>{y.value=!1}).catch(n=>{console.error("Error loading draft data:",n),y.value=!1}):(d.value={name:e.name,startDate:e.startDate,startTime:e.startTime,endDate:e.endDate,endTime:e.endTime,priority:e.priority,agents:[...e.agents],clients:[...e.clients],attachments:JSON.parse(JSON.stringify(e.attachments)),description:c.value},setTimeout(()=>{y.value=!1},800))}).catch(s=>{console.error("Error checking access:",s),y.value=!1})}),ue(()=>{A.value&&A.value(),N.setLayout({hideSidebar:!1,hideHeader:!1,hideFooter:!1,background:"#f9fafb"})});const K=s=>{l.value=s,e.agents=s.map(t=>t.id),e.agentDetails=s,k.value=!0},Q=s=>{i.value=s,e.clients=s.map(t=>t.id),e.clientDetails=s,k.value=!0},X=s=>{l.value=l.value.filter(t=>t.id!==s),e.agents=l.value.map(t=>t.id),e.agentDetails=l.value,k.value=!0},Z=s=>{i.value=i.value.filter(t=>t.id!==s),e.clients=i.value.map(t=>t.id),e.clientDetails=i.value,k.value=!0},ee=()=>{P()&&U()&&k.value?C.value=!0:(D.value=!0,o.query.draftId?o.query.from?u.push(`/tasks/${o.query.from}`):o.query.mode==="edit"?u.push(`/tasks/${o.query.draftId}`):u.push("/tasks/drafts"):u.push("/tasks"))},te=()=>{var g;const s=parseInt(o.query.draftId),t=w(e.startDate),n=w(e.endDate),r=c.value?c.value.split("##").map(M=>`- ${M.trim()}`).filter(M=>M!=="- "):((g=h.getTaskById(s))==null?void 0:g.description)||[],v={title:e.name,startDate:t,endDate:n,startTime:e.startTime,endTime:e.endTime,priority:e.priority,agents:e.agents,agentDetails:l.value,clients:e.clients,clientDetails:i.value,status:"draft",attachments:e.attachments,description:r};h.updateTask(s,v)},P=()=>e.name.trim()!==""||e.agents.length>0||e.clients.length>0||e.attachments.length>0||c.value.trim()!=="",ae=()=>{try{if(o.query.draftId)te();else{const s=w(e.startDate),t=w(e.endDate),n=c.value?c.value.split("##").map(v=>`- ${v.trim()}`).filter(v=>v!=="- "):[],r={title:e.name||"Untitled Task",startDate:s,endDate:t,startTime:e.startTime,endTime:e.endTime,priority:e.priority,agents:e.agents,agentDetails:l.value,clients:e.clients,clientDetails:i.value,status:"draft",isPartiallyComplete:!0,attachments:e.attachments,description:n};h.saveAsDraft(r)}D.value=!0,C.value=!1,o.query.from?u.push(`/tasks/${o.query.from}`):u.push("/tasks/drafts")}catch(s){console.error("Failed to save draft:",s),alert("Failed to save draft. Please try again.")}},se=()=>{C.value=!1,D.value=!0,o.query.from?u.push(`/tasks/${o.query.from}`):u.push("/tasks")},ne=()=>{try{const s=new Date(`${e.startDate} ${e.startTime}`);if(!G(e.startDate,e.startTime)){alert("Start date cannot be in the past");return}if(!Y(e.startDate,e.startTime,e.endDate,e.endTime)){alert("End date/time must be after start date/time");return}if(e.agents.length===0){alert("Please select at least one agent");return}if(e.clients.length===0){alert("Please select at least one client");return}if(!z.validateMultipleInteractions(e.agents,e.clients)){alert("Tasks can only be scheduled between connected agents and clients. Please ensure all clients have a connection with at least one of the selected agents.");return}const n=c.value?c.value.split("##").map(g=>`- ${g.trim()}`).filter(g=>g!=="- "):[],r={title:e.name,startDate:e.startDate,endDate:e.endDate,startTime:e.startTime,endTime:e.endTime,priority:e.priority,agents:e.agents,agentDetails:l.value,clients:e.clients,clientDetails:i.value,attachments:e.attachments,description:n,formattedStartDate:s.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),formattedStartTime:s.toISOString()};let v;if(o.query.draftId){const g=Number(o.query.draftId);h.updateTask(g,{...r,status:"scheduled"}),v=g}else v=h.createTask(r),h.scheduleTask(v);D.value=!0,u.push("/tasks/scheduled")}catch(s){console.error("Failed to create task:",s),alert("Failed to create task. Please try again.")}},U=()=>{if(!d.value||e.name!==d.value.name||e.startDate!==d.value.startDate||e.startTime!==d.value.startTime||e.endDate!==d.value.endDate||e.endTime!==d.value.endTime||e.priority!==d.value.priority||c.value!==d.value.description||e.agents.length!==d.value.agents.length||e.clients.length!==d.value.clients.length||e.attachments.length!==d.value.attachments.length)return!0;for(let s=0;s<e.agents.length;s++)if(!d.value.agents.includes(e.agents[s]))return!0;for(let s=0;s<e.clients.length;s++)if(!d.value.clients.includes(e.clients[s]))return!0;for(let s=0;s<e.attachments.length;s++){const t=e.attachments[s];if(!d.value.attachments.find(r=>r.id===t.id))return!0}return!1},re=s=>new Promise((t,n)=>{try{const r=h.getTaskById(s);r?(e.name=r.title,e.startDate=w(r.startDate),e.startTime=r.startTime,e.endDate=w(r.endDate),e.endTime=r.endTime,e.priority=r.priority,e.agents=r.agents,e.agentDetails=r.agentDetails,e.clients=r.clients,e.clientDetails=r.clientDetails,e.attachments=r.attachments,e.description=r.description||[],c.value=r.description?r.description.map(v=>v.replace("- ","")).join(" ## "):"",l.value=r.agentDetails,i.value=r.clientDetails,d.value={name:r.title,startDate:e.startDate,startTime:r.startTime,endDate:e.endDate,endTime:r.endTime,priority:r.priority,agents:[...r.agents],clients:[...r.clients],attachments:JSON.parse(JSON.stringify(r.attachments)),description:c.value},t()):n(new Error("Draft not found"))}catch(r){n(r)}}),T=()=>{k.value=!0};return ce(()=>e.startDate,s=>{e.endDate<s&&(e.endDate=s)}),(s,t)=>(f(),p("div",_e,[a("header",{class:"task-header"},[a("div",{class:"task-header__left"},[a("button",{class:"task-header__back-btn",onClick:ee},t[10]||(t[10]=[a("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[a("path",{d:"M19 12H5M12 19l-7-7 7-7"})],-1)])),t[11]||(t[11]=a("div",{class:"task-header__title-container"},[a("h1",{class:"task-header__title"},"Create new task"),a("p",{class:"task-header__subtitle"},"Here, you can add, remove, edit properties on your profile")],-1))]),t[12]||(t[12]=ve('<div class="task-header__right" data-v-435934c8><button class="task-header__icon-btn" data-v-435934c8><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-435934c8><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" data-v-435934c8></path><polyline points="22,6 12,13 2,6" data-v-435934c8></polyline></svg></button><button class="task-header__icon-btn" data-v-435934c8><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-435934c8><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" data-v-435934c8></path><path d="M13.73 21a2 2 0 0 1-3.46 0" data-v-435934c8></path></svg></button><div class="task-header__user" data-v-435934c8><img src="https://res.cloudinary.com/dnuhjsckk/image/upload/v1739408381/Screenshot_2025-02-13_015617_mhjgby.png" alt="User" class="task-header__avatar" data-v-435934c8><span class="task-header__username" data-v-435934c8>Alex Dunia</span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-435934c8><polyline points="6 9 12 15 18 9" data-v-435934c8></polyline></svg></div></div>',1))]),y.value?(f(),p("div",Se,t[13]||(t[13]=[a("div",{class:"skeleton-loader"},null,-1)]))):(f(),p("div",xe,[t[32]||(t[32]=a("h2",{class:"task-create__main-title"},"Create a task",-1)),a("form",{class:"task-create__form",onSubmit:V(ne,["prevent"])},[a("div",Ie,[t[14]||(t[14]=a("label",{for:"taskName"},"Name of task",-1)),b(a("input",{type:"text",id:"taskName","onUpdate:modelValue":t[0]||(t[0]=n=>e.name=n),placeholder:"Visit offshore island",required:"",onInput:T},null,544),[[_,e.name]])]),a("div",qe,[a("div",je,[t[16]||(t[16]=a("label",{for:"startDate"},"Start date",-1)),a("div",Ae,[b(a("input",{type:"date",id:"startDate","onUpdate:modelValue":t[1]||(t[1]=n=>e.startDate=n),required:"",onInput:T},null,544),[[_,e.startDate]]),t[15]||(t[15]=a("svg",{class:"select-arrow",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[a("polyline",{points:"6 9 12 15 18 9"})],-1))])]),a("div",Be,[t[18]||(t[18]=a("label",{for:"startTime"},"Start time",-1)),a("div",Me,[b(a("input",{type:"time",id:"startTime","onUpdate:modelValue":t[2]||(t[2]=n=>e.startTime=n),required:"",onInput:T},null,544),[[_,e.startTime]]),t[17]||(t[17]=a("svg",{class:"select-arrow",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[a("polyline",{points:"6 9 12 15 18 9"})],-1))])])]),a("div",$e,[a("div",Ve,[t[20]||(t[20]=a("label",{for:"endDate"},"End date",-1)),a("div",Ne,[b(a("input",{type:"date",id:"endDate","onUpdate:modelValue":t[3]||(t[3]=n=>e.endDate=n),required:"",onInput:T},null,544),[[_,e.endDate]]),t[19]||(t[19]=a("svg",{class:"select-arrow",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[a("polyline",{points:"6 9 12 15 18 9"})],-1))])]),a("div",Fe,[t[22]||(t[22]=a("label",{for:"endTime"},"End time",-1)),a("div",Pe,[b(a("input",{type:"time",id:"endTime","onUpdate:modelValue":t[4]||(t[4]=n=>e.endTime=n),required:"",onInput:T},null,544),[[_,e.endTime]]),t[21]||(t[21]=a("svg",{class:"select-arrow",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[a("polyline",{points:"6 9 12 15 18 9"})],-1))])])]),a("div",Ue,[t[25]||(t[25]=a("label",{for:"priority"},"Priority status",-1)),a("div",Ee,[b(a("select",{id:"priority","onUpdate:modelValue":t[5]||(t[5]=n=>e.priority=n),onChange:T},t[23]||(t[23]=[a("option",{value:"low"},"Low",-1),a("option",{value:"medium"},"Medium",-1),a("option",{value:"high"},"High",-1)]),544),[[me,e.priority]]),t[24]||(t[24]=a("svg",{class:"select-arrow",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[a("polyline",{points:"6 9 12 15 18 9"})],-1))])]),a("div",Le,[t[28]||(t[28]=a("label",null,"Add an agent",-1)),a("div",{class:"custom-select",onClick:t[6]||(t[6]=n=>q.value=!0)},[a("div",He,S(l.value.length>0?`${l.value.length} agent(s) selected`:"Select from your contacts who you want to tour"),1),t[26]||(t[26]=a("svg",{class:"select-arrow",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[a("polyline",{points:"6 9 12 15 18 9"})],-1))]),l.value.length>0?(f(),p("div",Oe,[(f(!0),p(H,null,O(l.value,n=>(f(),p("div",{key:n.id,class:"selected-item"},[a("div",Re,[a("img",{src:n.avatar,alt:"Agent avatar",class:"selected-item-avatar"},null,8,Je),a("span",ze,S(n.name),1)]),a("button",{class:"remove-item-btn",onClick:V(r=>X(n.id),["stop"])},t[27]||(t[27]=[a("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[a("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),a("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)]),8,Ge)]))),128))])):$("",!0)]),a("div",Ye,[t[31]||(t[31]=a("label",null,"Add your client",-1)),a("div",{class:"custom-select",onClick:t[7]||(t[7]=n=>j.value=!0)},[a("div",We,S(i.value.length>0?`${i.value.length} client(s) selected`:"Select from your contacts who you want to tour"),1),t[29]||(t[29]=a("svg",{class:"select-arrow",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[a("polyline",{points:"6 9 12 15 18 9"})],-1))]),i.value.length>0?(f(),p("div",Ke,[(f(!0),p(H,null,O(i.value,n=>(f(),p("div",{key:n.id,class:"selected-item"},[a("div",Qe,[a("img",{src:n.avatar,alt:"Client avatar",class:"selected-item-avatar"},null,8,Xe),a("span",Ze,S(n.name),1)]),a("button",{class:"remove-item-btn",onClick:V(r=>Z(n.id),["stop"])},t[30]||(t[30]=[a("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[a("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),a("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)]),8,et)]))),128))])):$("",!0)]),a("div",tt,[a("button",at,S(pe(o).query.draftId?"Update Task":"Create Task"),1)])],32)])),L(ge,{show:q.value,agents:B.value,"selected-agents":l.value,onClose:t[8]||(t[8]=n=>q.value=!1),onSelect:K},null,8,["show","agents","selected-agents"]),L(he,{show:j.value,clients:W.value,"selected-clients":i.value,onClose:t[9]||(t[9]=n=>j.value=!1),onSelect:Q},null,8,["show","clients","selected-clients"]),C.value?(f(),p("div",st,[a("div",{class:"dialog"},[t[33]||(t[33]=a("h3",null,"Save as Draft?",-1)),t[34]||(t[34]=a("p",null,"You have unsaved changes. Would you like to save your progress as a draft?",-1)),a("div",{class:"dialog-actions"},[a("button",{class:"btn btn-secondary",onClick:se},"No"),a("button",{class:"btn btn-primary",onClick:ae},"Yes")])])])):$("",!0)]))}},ut=we(nt,[["__scopeId","data-v-435934c8"]]);export{ut as default};
